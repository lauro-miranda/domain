using System.Collections.Generic;
using System.Text.RegularExpressions;
using LM.Responses;
using LM.Responses.Extensions;

namespace LM.Domain.Valuables
{
    public class Email : ValueObject
    {
        Email() { }
        Email(string address) { Address = address; }

        public string Address { get; private set; }

        protected override IEnumerable<object> GetAtomicValues()
        {
            yield return Address;
        }

        public bool IsValid() => IsValid(Address);

        public static bool IsValid(string address)
        {
            if (string.IsNullOrEmpty(address))
                return false;

            // Mail::RFC822::Address: regexp-based address validation
            // http://www.ex-parrot.com/~pdw/Mail-RFC822-Address.html
            var regex = @"(?:(?:\r\n)?[ \t])*(?:(?:(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*|(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)*\<(?:(?:\r\n)?[ \t])*(?:@(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[\t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*(?:,@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[\t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*)*:(?:(?:\r\n)?[ \t])*)?(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*\>(?:(?:\r\n)?[ \t])*)|(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)*:(?:(?:\r\n)?[ \t])*(?:(?:(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*|(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)*\<(?:(?:\r\n)?[ \t])*(?:@(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*(?:,@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*)*:(?:(?:\r\n)?[ \t])*)?(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*\>(?:(?:\r\n)?[ \t])*)(?:,\s*(?:(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*|(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)*\<(?:(?:\r\n)?[ \t])*(?:@(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*(?:,@(?:(?:\r\n)?[\t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*)*:(?:(?:\r\n)?[ \t])*)?(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|'(?:[^\'\r\\]|\\.|(?:(?:\r\n)?[ \t]))*'(?:(?:\r\n)?[ \t])*))*@(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*)(?:\.(?:(?:\r\n)?[ \t])*(?:[^()<>@,;:\\'.\[\] \000-\031]+(?:(?:(?:\r\n)?[ \t])+|\Z|(?=[\['()<>@,;:\\'.\[\]]))|\[([^\[\]\r\\]|\\.)*\](?:(?:\r\n)?[ \t])*))*\>(?:(?:\r\n)?[ \t])*))*)?;\s*)";
            var regexEmail = new Regex(regex);
            return regexEmail.IsMatch(address);
        }

        public static Response<Email> Create(string address)
        {
            if (!IsValid(address))
                return Response<Email>.Create().WithBusinessError(nameof(Email), "E-mail não é válido.");

            return new Email(address);
        }

        public static implicit operator Email(Maybe<Email> entity) => entity.Value;

        public static implicit operator Email(Response<Email> entity) => entity.Data;
    }
}